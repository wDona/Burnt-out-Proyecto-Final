CREATE TABLE Organizacion (
    ID_Org INTEGER NOT NULL PRIMARY KEY,
    Org_Name TEXT NOT NULL
);

CREATE TABLE Usuario (
    ID_Usuario INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    Username TEXT NOT NULL UNIQUE,
    Contrasena TEXT NOT NULL,
    Nombre TEXT NOT NULL,
    Riesgo_Burnout REAL,
    Descripcion TEXT,
    FK_ID_Organizacion INTEGER NOT NULL,
    FOREIGN KEY(FK_ID_Organizacion) REFERENCES Organizacion(ID_Org)
);

CREATE TABLE Ajuste (
    ID_Ajuste INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    Nombre_Ajuste TEXT NOT NULL
);

CREATE TABLE Tablero (
    ID_Tabl INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    Titulo TEXT NOT NULL,
    FK_ID_Org INTEGER NOT NULL,
    FK_ID_Equipo INTEGER, -- Anadido a posteriori, faltaba en el disenio
    FOREIGN KEY(FK_ID_Org) REFERENCES Organizacion(ID_Org)
);

CREATE TABLE Equipo (
    ID_Equipo INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    Titulo TEXT NOT NULL,
    Puntuacion INTEGER DEFAULT 0, -- Anadido a posteriori, faltaba en el disenio
    FK_ID_Org INTEGER NOT NULL,
    FOREIGN KEY(FK_ID_Org) REFERENCES Organizacion(ID_Org)
);

CREATE TABLE Pregunta (
    ID_Pregunta INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    Pregunta TEXT NOT NULL,
    FK_ID_Org INTEGER NOT NULL,
    FOREIGN KEY(FK_ID_Org) REFERENCES Organizacion(ID_Org)
);

CREATE TABLE Tarea (
    ID_Tarea INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    Titulo TEXT NOT NULL,
    Descripcion TEXT,
    Estado TEXT NOT NULL,
    FK_ID_Tabl INTEGER NOT NULL,
    FK_ID_Usuario INTEGER NOT NULL,
    FOREIGN KEY(FK_ID_Tabl) REFERENCES Tablero(ID_Tabl),
    FOREIGN KEY(FK_ID_Usuario) REFERENCES Usuario(ID_Usuario)
);

CREATE TABLE Subtarea (
    ID_Subtarea INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    Titulo TEXT NOT NULL,
    Completado INTEGER NOT NULL,
    FK_ID_Tarea INTEGER NOT NULL,
    FOREIGN KEY(FK_ID_Tarea) REFERENCES Tarea(ID_Tarea)
);

CREATE TABLE User_Team (
    ID_Usuario INTEGER NOT NULL,
    ID_Equipo INTEGER NOT NULL,
    PRIMARY KEY (ID_Usuario, ID_Equipo),
    FOREIGN KEY(ID_Usuario) REFERENCES Usuario(ID_Usuario),
    FOREIGN KEY(ID_Equipo) REFERENCES Equipo(ID_Equipo)
);

CREATE TABLE Ajuste_User (
    ID_Usuario INTEGER NOT NULL,
    ID_Ajuste INTEGER NOT NULL,
    Valor_Ajuste TEXT,
    PRIMARY KEY (ID_Usuario, ID_Ajuste),
    FOREIGN KEY(ID_Usuario) REFERENCES Usuario(ID_Usuario),
    FOREIGN KEY(ID_Ajuste) REFERENCES Ajuste(ID_Ajuste)
);

CREATE TABLE Responder (
    ID_Usuario INTEGER NOT NULL,
    ID_Pregunta INTEGER NOT NULL,
    Anonimo INTEGER NOT NULL,
    Respuesta TEXT NOT NULL,
    PRIMARY KEY (ID_Usuario, ID_Pregunta),
    FOREIGN KEY(ID_Usuario) REFERENCES Usuario(ID_Usuario),
    FOREIGN KEY(ID_Pregunta) REFERENCES Pregunta(ID_Pregunta)
);

CREATE TABLE Pendientes (
    ID_Accion INTEGER NOT NULL,
    tipo_accion TEXT NOT NULL, -- 'CREATE', 'UPDATE', 'DELETE'
    tabla_afectada TEXT NOT NULL, -- 'Tarea', 'Tablero', 'Ajuste', 'Responder', etc
    id_afectado INTEGER NOT NULL,
    datos_json TEXT NOT NULL, -- JSON con los datos a sincronizar
    timestamp_creacion INTEGER NOT NULL,
    sincronizado INTEGER DEFAULT 0, -- 0 = pendiente, 1 = sincronizado
    PRIMARY KEY (ID_Accion)
);

-- Indices para búsquedas rápidas
CREATE INDEX idx_sync_log_sincronizado ON Pendientes(sincronizado);
CREATE INDEX idx_sync_log_tabla ON Pendientes(tabla_afectada);
CREATE INDEX idx_sync_log_timestamp ON Pendientes(timestamp_creacion);

-- ======= INSERCIONES DE DATOS INICIALES =======
insertOrgbase:
INSERT OR IGNORE INTO Organizacion(Org_Name) VALUES('Organizacion Predeterminada');

insertEquipoBase:
INSERT OR IGNORE INTO Equipo(Titulo, FK_ID_Org) VALUES('Equipo Predeterminado', 1);

insertAjustes:
INSERT OR IGNORE INTO Ajuste(Nombre_Ajuste) VALUES('Notificaciones'); -- TODO: anadir permiso en android
INSERT OR IGNORE INTO Ajuste(Nombre_Ajuste) VALUES('Tema Oscuro');

insertUsuarioBase:
INSERT OR IGNORE INTO Usuario(Username, Contrasena, Nombre, FK_ID_Organizacion) VALUES('User', '********', 'Usuario Base', 1);
INSERT OR IGNORE INTO User_Team(ID_Usuario, ID_Equipo) VALUES(1, 1);


-- ===== QUERIES DE TABLAS =====

insertTarea:
INSERT INTO Tarea(Titulo, Descripcion, Estado, FK_ID_Tabl, FK_ID_Usuario)
VALUES(?, ?, ?, ?, ?);

insertTablero:
INSERT INTO Tablero(Titulo, FK_ID_Equipo, FK_ID_Org)
VALUES(?, ?, ?);

insertEquipo:
INSERT INTO Equipo(Titulo, FK_ID_Org)
VALUES(?, ?);

getTareasByTablero:
SELECT * FROM Tarea WHERE FK_ID_Tabl = ?;

getTablerosByOrg:
SELECT * FROM Tablero WHERE FK_ID_Org = ?;

getUserById:
SELECT * FROM Usuario WHERE ID_Usuario = ?;

getEquipoById:
SELECT * FROM Equipo WHERE ID_Equipo = ?;

getEquiposByOrg:
SELECT * FROM Equipo WHERE FK_ID_Org = ?;

getUsuariosByEquipo:
SELECT u.ID_Usuario, u.Username, u.Nombre, u.Riesgo_Burnout, u.Descripcion, u.FK_ID_Organizacion
FROM Usuario u JOIN User_Team ut ON u.ID_Usuario = ut.ID_Usuario
WHERE ut.ID_Equipo = ?;

getAjustesByUser:
SELECT a.Nombre_Ajuste, au.Valor_Ajuste
FROM Ajuste a JOIN Ajuste_User au ON a.ID_Ajuste = au.ID_Ajuste
WHERE au.ID_Usuario = ?;

getOrganizacionById:
SELECT * FROM Organizacion WHERE ID_Org = ?;

getPreguntasByOrg:
SELECT * FROM Pregunta WHERE FK_ID_Org = ?;

getRespuestasByPregunta:
SELECT r.Respuesta, r.Anonimo, u.Nombre
FROM Responder r JOIN Usuario u ON r.ID_Usuario = u.ID_Usuario
WHERE r.ID_Pregunta = ?;

